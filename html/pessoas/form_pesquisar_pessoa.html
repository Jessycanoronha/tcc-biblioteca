<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="utf-8">
  <title> Adicionando Pessoa ao Cadastro | Qg da Leitura </title>
  <link rel="stylesheet" href="../../css/style_form.css">
</head>
<body>
<div class="interface">
  <a class="btn bt-voltar" href="menu_pessoas.html"> Menu </a>
  <h1> Registrar empréstimo ou devolução </h1>
  <form class="frm frm-medium">
    <fieldset>
      <legend> Pesquisar </legend>
      <label> Informe o nome da pessoa para o sistema </label>
      <div>
        <input type="text" placeholder="Faça a sua busca" name="nome" size="35" maxlength="15" autofocus id="query">
        <button type="button" class="btn bt confirm" onclick="buscarPessoa()"> Pesquisar </button>
      </div>
    </fieldset>
  </form>
  <div class="resposta">
    <div id="resultone"></div>
  </div>
  <div class="interface-resposta"></div>
  <script>
    var butao = "<button class='btn filtro' type='button' onclick='voltar()'> Voltar a pesquisa </button>";

    // Função que não deixa enviar nada caso o usuário digitou alguma coisa
    function verificaCampo(campo) {
      if(document.getElementById(campo).value == "") {
        alert("Digite alguma entrada válida, não deixe o campo em branco");
        document.getElementById(campo).focus();
        return false;
      } else {
        return true;
      }
    }

    // Função que retorna o resultado da pesquisa
    function buscarPessoa() {
      var result = verificaCampo("query");

      if(result) {
        var pesquisa = document.getElementById("query").value;
        // Fazendo surgir a tela de resposta
        document.getElementsByClassName("resposta")[0].style.display = "block";
        document.getElementsByClassName("frm")[0].style.display = "none";

        var http = new XMLHttpRequest();

        http.onreadystatechange = function() {
          if (http.readyState == 4 && http.status == 200) {
            var resposta = http.responseText;
            document.getElementById("resultone").style.display = "block";
            document.getElementById("resultone").innerHTML = resposta + butao;
          } else {
            document.getElementById("resultone").style.display = "block";
            document.getElementById("resultone").innerHTML = "<p> Carregando... </p>";
          }
        }

        http.open("GET", "http://127.0.0.1/tcc-biblioteca/php/arq_pessoas/pesquisa_pessoa.php?nome=" + pesquisa, true);
        http.send();
      }
    }

    // Função que mostra o butao para mostrar os dados do aluno
    function respondeChecked() {
      var id = document.querySelector("input[type='radio']:checked").value;
      // Armazenando o id do aluno no localStorage
      localStorage.setItem("id", id);

      if(document.querySelector(".resposta button.filtro")) {
        if(!(document.querySelector(".resposta button.confirm"))) {
          var text = document.createTextNode("Ver dados da pessoa"),
              button = document.createElement("button");

          // Criando o butao
          button.setAttribute("class", "btn bt confirm");
          button.appendChild(text);
          document.getElementById("resultone").appendChild(button);

          // Chamando a função que irá fazer a requisição ajax para saber se o aluno está ou não com livro emprestado
          button.addEventListener("click", mostrarDados);
        }
      }
    }

    // Função que faz requisição no banco de dados e mostra os dados do aluno
    function mostrarDados() {
      document.getElementsByClassName("interface-resposta")[0].style.display = "block";
      var idnaluno = localStorage.getItem("id");

      var http = new XMLHttpRequest();

      http.onreadystatechange = function() {
        if (http.readyState == 4 && http.status == 200) {
          document.getElementsByClassName("resposta")[0].style.display = "none";
          var resposta = http.responseText;
          document.getElementsByClassName("interface-resposta")[0].innerHTML = resposta;
        } else {
          document.getElementsByClassName("resposta")[0].innerHTML = "<p> Carregando... </p>";
        }
      }

      http.open("GET", "http://127.0.0.1/tcc-biblioteca/php/arq_pessoas/pesquisa_pessoa.php?idnaluno=" + idnaluno, true);
      http.send();
    }

    // Função que busca os dados do livro no banco de dados
    function buscaLivro(x) {
      var result = verificaCampo("titulo");

      if(result) {
        var pesq = document.getElementById("titulo").value;
        var div = document.getElementById("recebeBusca");

        var http = new XMLHttpRequest();

        http.onreadystatechange = function() {
          if (http.readyState == 4 && http.status == 200) {
            var resposta = http.responseText;
            div.style.display = "block";
            div.innerHTML = resposta;
          } else {
            div.innerHTML = "<p> Carregando... </p>";
          }
        }

        http.open("GET", "http://127.0.0.1/tcc-biblioteca/php/arq_livros/buscaLivro.php?query=" + pesq, true);
        http.send();
      }
    }

    // Função que mostra os dados do livro e cria o botao de confirmação de emprestimo
    function respondeEmprestimo(x) {
      var cod = x;
      localStorage.setItem("cod_book", cod); // Armazenando o codigo do livro

      var text = document.createTextNode("Ver dados do livro"),
          button = document.createElement("button");

        // Criando o butao
        button.setAttribute("class", "btn bt confirm");
        button.appendChild(text);
        document.getElementById("resultsthree").style.display = "block";
        document.getElementById("resultsthree").appendChild(button);

        // Mostrando os dados do livro
        button.addEventListener("click", function() {
          var http = new XMLHttpRequest();

          http.onreadystatechange = function() {
            if (http.readyState == 4 && http.status == 200) {
              var resposta = http.responseText;
              document.getElementById("resultsthree").innerHTML = resposta;
            } else {
              document.getElementById("resultsthree").innerHTML = "<p> Carregando... </p>";
            }
          }

          http.open("GET", "http://127.0.0.1/tcc-biblioteca/php/arq_pessoas/registrar_emprestimo.php?query=" + cod, true);
          http.send();
        });
    }

    // Função que confirma o emprestimo
    function confirmarEmprestimo() {
      var data = document.getElementById("date").value;
      var prazo = document.getElementById("selectDate").value;
      var idnaluno = localStorage.getItem("id");
      var cod = localStorage.getItem("cod_book");

      var http = new XMLHttpRequest();

      http.onreadystatechange = function() {
        if (http.readyState == 4 && http.status == 200) {
          var resposta = http.responseText;
          document.getElementById("resultsthree").innerHTML = resposta;
          var button = document.createElement("button");
          var text = document.createTextNode("Voltar a pesquisa de alunos");
          button.appendChild(text);
          button.setAttribute("class", "btn bt confirm");
          document.getElementsByClassName("resposta").appendChild(button);
          button.addEventListener("click", voltarPesquisa);
        } else {
          document.getElementById("resultsthree").innerHTML = "<p> Carregando... </p>";
        }
      }

      http.open("GET", "http://127.0.0.1/tcc-biblioteca/php/arq_pessoas/registro_final.php?idnaluno=" + idnaluno + "&cod_book=" + cod + "&data=" + data + "&prazo=" + prazo, true);
      http.send();
    }

    // Função que obtem os dados do emprestimo, para devolução
    function mostrarEmprestimo() {
      var idnaluno = localStorage.getItem("id");
      var idlivro = document.getElementById("bt-reg").dataset.idlivro;
      var idReg = document.getElementById("bt-reg").dataset.idreg;
      localStorage.setItem("idlivro", idlivro); // Armazenando o id do livro
      localStorage.setItem("idregistro", idReg); // Armazenando o id de registro do emprestimo

      var http = new XMLHttpRequest();

      http.onreadystatechange = function() {
        if (http.readyState == 4 && http.status == 200) {
          var resposta = http.responseText;
          document.getElementById("resultsthree").innerHTML = resposta;
        } else {
          document.getElementById("resultsthree").innerHTML = "<p> Carregando... </p>";
        }
      }

      http.open("GET", "http://127.0.0.1/tcc-biblioteca/php/arq_pessoas/registrar_devolucao.php?idnaluno=" + idnaluno + "&idlivro=" + idlivro + "&idreg=" + idReg, true);
      http.send();
    }

    // Função que confirma devolução
    function confirmaDevolucao() {
      var idnaluno = localStorage.getItem("id");
      var idlivro = localStorage.getItem("idlivro");
      var data = document.getElementById("selectDate").value;

      var http = new XMLHttpRequest();

      http.onreadystatechange = function() {
        if (http.readyState == 4 && http.status == 200) {
          var resposta = http.responseText;
          document.getElementById("resultsthree").innerHTML = resposta;
          var button = document.createElement("button");
          var text = document.createTextNode("Voltar a pesquisa de pessoas");
          button.appendChild(text);
          button.setAttribute("class", "btn bt confirm");
          document.getElementById("resultsthree").appendChild(button);
          button.addEventListener("click", voltar);
        } else {
          document.getElementById("resultsthree").innerHTML = "<p> Carregando... </p>";
        }
      }

      http.open("GET", "http://127.0.0.1/tcc-biblioteca/php/arq_pessoas/registrar_devolucao.php?idnAluno=" + idnaluno + "&idLivro=" + idlivro + "&data=" + data, true);
      http.send();
    }

    // Função que retorna pesquisa dos alunos
    function voltar() {
      window.location.reload();
    }
  </script>
</div>
</body>
</html>
